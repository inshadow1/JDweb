"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["688"],{1130:function(e,r,n){n.r(r),n.d(r,{default:()=>p,frontMatter:()=>l,metadata:()=>o,assets:()=>d,toc:()=>i,contentTitle:()=>c});var o=JSON.parse('{"id":"\u540E\u7AEF/5.2-\u4E3B\u8981\u6982\u5FF5","title":"5.2-\u4E3B\u8981\u6982\u5FF5","description":"Create by fall on 14 Dec 2021","source":"@site/my-docs/\u540E\u7AEF/5.2-\u4E3B\u8981\u6982\u5FF5.md","sourceDirName":"\u540E\u7AEF","slug":"/\u540E\u7AEF/5.2-\u4E3B\u8981\u6982\u5FF5","permalink":"/docs/\u540E\u7AEF/5.2-\u4E3B\u8981\u6982\u5FF5","draft":false,"unlisted":false,"editUrl":"https://github.com/my-docs/\u540E\u7AEF/5.2-\u4E3B\u8981\u6982\u5FF5.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"5.1-nestjs","permalink":"/docs/\u540E\u7AEF/5.1-nestjs"},"next":{"title":"5.3-\u6570\u636E\u5E93\u64CD\u4F5C","permalink":"/docs/\u540E\u7AEF/5.3-\u6570\u636E\u5E93\u64CD\u4F5C"}}'),s=n("2676"),t=n("3663");let l={},c=void 0,d={},i=[{value:"Controller",id:"controller",level:2},{value:"Provider",id:"provider",level:2},{value:"Modules",id:"modules",level:2},{value:"dynamic modules",id:"dynamic-modules",level:3},{value:"Middleware",id:"middleware",level:2},{value:"\u51FD\u6570\u5F0F\u5199\u6CD5",id:"\u51FD\u6570\u5F0F\u5199\u6CD5",level:3},{value:"\u610F\u5916\u6355\u83B7",id:"\u610F\u5916\u6355\u83B7",level:2},{value:"\u7BA1\u9053",id:"\u7BA1\u9053",level:2},{value:"\u5B88\u536B",id:"\u5B88\u536B",level:2},{value:"\u62E6\u622A\u5668",id:"\u62E6\u622A\u5668",level:2},{value:"\u81EA\u5B9A\u4E49\u8DEF\u7531\u88C5\u9970\u5668",id:"\u81EA\u5B9A\u4E49\u8DEF\u7531\u88C5\u9970\u5668",level:2}];function a(e){let r={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsxs)(r.p,{children:["Create by ",(0,s.jsx)(r.strong,{children:"fall"})," on 14 Dec 2021\r\nRecently revised in 22 Aug 2024"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"controller",children:"Controller"}),"\n",(0,s.jsx)(r.p,{children:"\u63A7\u5236\u5668"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"\u63A7\u5236\u5668"}),"\u5904\u7406\u4F20\u5165\u7684\u8BF7\u6C42\u548C\u60F3\u5BA2\u6237\u7AEF\u8FD4\u56DE\u7684\u54CD\u5E94\uFF0C"]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"\u8DEF\u7531"}),"\u673A\u5236\u63A7\u5236\u90A3\u4E2A\u63A7\u5236\u5668\u5904\u7406\u90A3\u4E2A\u8BF7\u6C42\u3002\u901A\u5E38\u6BCF\u4E2A\u63A7\u5236\u5668\u6709\u591A\u4E2A\u8DEF\u7531\uFF0C\u4E0D\u540C\u7684\u8DEF\u7531\u8FDB\u884C\u4E0D\u540C\u7684\u64CD\u4F5C\u3002"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",children:"/* cats.controller.ts */\r\nimport { Controller, Get } from '@nestjs/common';\r\n@Controller('cats')\r\nexport class CatsController {\r\n  @Get('/around') // \u7528\u4E8E\u544A\u8BC9 Nest \u4E3A HTTP \u8BF7\u6C42\u7684\u7279\u5B9A\u7AEF\u70B9\u521B\u5EFA\u5904\u7406\u7A0B\u5E8F\r\n  findAll(): string {\r\n    return 'This action returns all cats';\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u8DEF\u7531\u8DEF\u5F84 \uFF1F\u4E00\u4E2A\u5904\u7406\u7A0B\u5E8F\u7684\u8DEF\u7531\u8DEF\u5F84\u662F\u901A\u8FC7\u8FDE\u63A5\u4E3A\u63A7\u5236\u5668 \uFF08Controller\uFF09 \u58F0\u660E\u7684\uFF08\u53EF\u9009\uFF09\u524D\u7F00\u548C\u8BF7\u6C42\u88C5\u9970\u5668\u4E2D\u6307\u5B9A\u7684\u4EFB\u4F55\u8DEF\u5F84\u6765\u786E\u5B9A\u7684\u3002"}),"\n",(0,s.jsx)(r.h2,{id:"provider",children:"Provider"}),"\n",(0,s.jsx)(r.p,{children:"Controller \u4F1A\u8C03\u7528 provider \u4E2D\u7684\u51FD\u6570\uFF0C"}),"\n",(0,s.jsx)(r.p,{children:"provider \u5305\u62EC service"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"// \u521B\u5EFA code.service.ts\r\nimport { Injectable } from '@nestjs/common'\r\n@Injectable()\r\nexport class CodeService {\r\n  findAll () {\r\n    return [{\r\n      name: '\u4EE3\u7801\u7247\u6BB51',\r\n      content: 'const a = 106',\r\n    }]\r\n  }\r\n}\r\n\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u8C03\u7528 service"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"// code.controller.ts\r\nimport { CodeService } from './code.service'\r\n@Controller('code')\r\nexport class CodeController {\r\n  //\r\n  constructor (private readonly codeService: CodeService) {}\r\n  @Get()\r\n  findAll () {\r\n    return this.codeService.findAll()\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"modules",children:"Modules"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"\r\nimport { Module, Global } from '@nestjs/common';\r\nimport { CatsController } from './cats.controller';\r\nimport { CatsService } from './cats.service';\r\n\r\n@Global() // \u5C06\u6B64\u6A21\u5757\u4F7F\u7528\u5168\u5C40\u8FDB\u884C\u66B4\u9732\r\n@Module({\r\n  controllers: [CatsController],\r\n  providers: [CatsService],\r\n  exports: [CatsService],\r\n})\r\nexport class CatsModule {}\r\n\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u5168\u5C40 module \u5E94\u8BE5\u53EA\u88AB\u6CE8\u518C\u4E00\u6B21"}),"\n",(0,s.jsx)(r.h3,{id:"dynamic-modules",children:"dynamic modules"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { Module, DynamicModule } from '@nestjs/common';\r\nimport { createDatabaseProviders } from './database.providers';\r\nimport { Connection } from './connection.provider';\r\n\r\n@Module({\r\n  providers: [Connection],\r\n  exports: [Connection],\r\n})\r\nexport class DatabaseModule {\r\n  static forRoot(entities = [], options?): DynamicModule {\r\n    const providers = createDatabaseProviders(options, entities);\r\n    return {\r\n      module: DatabaseModule,\r\n      providers: providers,\r\n      exports: providers,\r\n    };\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"middleware",children:"Middleware"}),"\n",(0,s.jsx)(r.p,{children:"\u4E2D\u95F4\u4EF6\uFF0C\u53EF\u4EE5\u505A\u54EA\u4E9B\u5185\u5BB9\uFF1F"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"\u5728\u7279\u5B9A\u8BF7\u6C42\u4E2D\uFF0C\u6267\u884C\u4EFB\u610F\u4EE3\u7801"}),"\n",(0,s.jsx)(r.li,{children:"\u5BF9\u8FD4\u56DE\u5185\u5BB9\u8FDB\u884C\u7EDF\u4E00\u5305\u88C5"}),"\n",(0,s.jsx)(r.li,{children:"\u7EC8\u6B62 request-response \u5FAA\u73AF"}),"\n",(0,s.jsx)(r.li,{children:"\u8FDB\u5165\u4E0B\u4E00\u4E2A\u4E2D\u95F4\u4EF6"}),"\n",(0,s.jsxs)(r.li,{children:["\u4E2D\u95F4\u4EF6\u5982\u679C\u6CA1\u6709\u7ED3\u675F request-response\u5FAA\u73AF\uFF0C\u5FC5\u987B\u8C03\u7528 ",(0,s.jsx)(r.code,{children:"next()"}),"\uFF0C\u5426\u5219\u5C06\u4F1A\u4E00\u76F4\u6302\u8D77"]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"\r\nimport { Module, NestModule, RequestMethod, MiddlewareConsumer } from '@nestjs/common';\r\nimport { LoggerMiddleware } from './common/middleware/logger.middleware';\r\nimport { CatsModule } from './cats/cats.module';\r\n\r\n@Module({\r\n  imports: [CatsModule],\r\n})\r\n// \u914D\u7F6E\u4E2D\u95F4\u4EF6\r\nexport class AppModule implements NestModule {\r\n  configure(consumer: MiddlewareConsumer) {\r\n    consumer\r\n      .apply(LoggerMiddleware)\r\n    	// \u5982\u679C\u8981\u4F7F\u7528\u591A\u4E2A\u4E2D\u95F4\u4EF6\u53EF\u4EE5\r\n    	// .apply(cors(), helmet(), logger)\r\n      .exclude( // \u6392\u9664\u4E00\u4E9B\u8DEF\u7531\r\n        { path: 'cats', method: RequestMethod.GET },\r\n        { path: 'cats', method: RequestMethod.POST },\r\n        'cats/(.*)',\r\n      )\r\n      .forRoutes({ path: 'cats', method: RequestMethod.GET });\r\n      // \u8FD8\u53EF\u4EE5\u7ED1\u5B9A Controller\r\n    	// .forRoutes(CatsController)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"\u51FD\u6570\u5F0F\u5199\u6CD5",children:"\u51FD\u6570\u5F0F\u5199\u6CD5"}),"\n",(0,s.jsx)(r.p,{children:"\u5982\u679C\u4F60\u7684\u4E2D\u95F4\u4EF6\u6CA1\u6709\u4EFB\u4F55\u4F9D\u8D56\uFF0C\u8BF7\u4F7F\u7528\u51FD\u6570\u5F0F\u4E2D\u95F4\u4EF6\u6765\u4EE3\u66FF"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { Request, Response, NextFunction } from 'express';\r\n\r\nexport function logger(req: Request, res: Response, next: NextFunction) {\r\n  console.log(`Request...`);\r\n  next();\r\n};\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u610F\u5916\u6355\u83B7",children:"\u610F\u5916\u6355\u83B7"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.a,{href:"https://docs.nestjs.com/exception-filters",children:"https://docs.nestjs.com/exception-filters"})}),"\n",(0,s.jsx)(r.p,{children:"\u9ED8\u8BA4\u5C31\u6709\u4E00\u4E2A\u5168\u5C40\u610F\u5916\u6355\u83B7"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "message": "Cannot POST /faker",\r\n  "error": "Not Found",\r\n  "statusCode": 404\r\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"\u81EA\u5B9A\u4E49\u5168\u5C40\u6355\u83B7"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-js",children:"@Get()\r\nasync findAll() {\r\n  throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u7BA1\u9053",children:"\u7BA1\u9053"}),"\n",(0,s.jsx)(r.p,{children:"pipe"}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.a,{href:"https://docs.nestjs.com/pipes",children:"https://docs.nestjs.com/pipes"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"\u5C06\u6570\u636E\u8F6C\u6362\u4E3A\u60F3\u8981\u7684\u7C7B\u578B"}),"\n",(0,s.jsx)(r.li,{children:"\u9A8C\u8BC1\uFF0C\u9A8C\u8BC1\u6570\u636E\u662F\u5426\u6709\u6548"}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"\u5F53\u5728 pipe \u4E2D\u629B\u51FA\u4E86\u4E00\u4E2A\u9519\u8BEF\uFF0C\u4E4B\u540E\u7684 controller \u5C06\u4E0D\u4F1A\u6267\u884C"}),"\n",(0,s.jsx)(r.p,{children:"nest \u63D0\u4F9B\u7684 pipe line"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ValidationPipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseIntPipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseFloatPipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseBoolPipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseArrayPipe"})}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"ParseUUIDPipe"}),"\uFF0C\u9A8C\u8BC1 ",(0,s.jsx)(r.code,{children:"ParseUUIDPipe()"})," \u4F60\u5728\u4F7F\u7528 UUID 3, 4 or 5 \u7684\u7248\u672C"]}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseEnumPipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"DefaultValuePipe"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.code,{children:"ParseFilePipe"})}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"\u4F7F\u7528"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"@Controller('code')\r\nexport class CodeController {\r\n  constructor (private readonly codeService: CodeService) {}\r\n\r\n	@Get(':id')\r\n  findOne (@Param('id', new ParseUUIDPipe()) id: string) {\r\n    // request\r\n    console.log('\uD83D\uDE80 ~ CodeController ~ findOne ~ request:', randomUUID())\r\n    return this.codeService.findOne(id)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"@Controller('code')\r\nexport class CodeController {\r\n  constructor (private readonly codeService: CodeService) {}@Post()\r\n  \r\n  @HttpCode(200)\r\n  create (@Body('codeType', ParseTypePipe) createCodeDto: CreateCodeDto) {\r\n    console.log('\uD83D\uDE80 ~ CodeController', createCodeDto)\r\n    return this.codeService.create(createCodeDto)\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(r.blockquote,{children:["\n",(0,s.jsx)(r.p,{children:"\u4E3A\u4EC0\u4E48\u4E0D\u662F\u4E2D\u95F4\u4EF6\uFF1F"}),"\n",(0,s.jsx)(r.p,{children:"\u4E2D\u95F4\u4EF6\u786E\u5B9E\u53EF\u4EE5\u5DE5\u4F5C\uFF0C\u4F46\u662F\u4E2D\u95F4\u4EF6\u5E76\u4E0D\u77E5\u9053\u4F60\u8C03\u7528\u4E86\u54EA\u4E2A\u53C2\u6570\uFF0C\u4F7F\u7528\u4E86\u54EA\u4E2A\u65B9\u6CD5\u56E0\u6B64\u5F88\u96BE\u521B\u9020\u51FA\u901A\u7528\u7684\u4E2D\u95F4\u4EF6"}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"\u589E\u5F3A dto"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"@Controller('code')\r\nexport class CodeController {\r\n  constructor (private readonly codeService: CodeService) {}\r\n\r\n  @Patch(':id')\r\n  @UseInterceptors(NoFilesInterceptor()) // \u63A5\u6536 FormData\r\n  update (@Param('id') id: string, @Body(new ValidationPipe()) updateCodeDto: UpdateCodeDto) {\r\n    console.log('\uD83D\uDE80 ~ CodeController ~ update ~ param:', updateCodeDto)\r\n    return this.codeService.update(id, updateCodeDto)\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u5B88\u536B",children:"\u5B88\u536B"}),"\n",(0,s.jsx)(r.p,{children:"guards"}),"\n",(0,s.jsx)(r.p,{children:"\u5B9A\u4E49\u4E00\u4E2A\u5B88\u536B\uFF1A"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common'\r\nimport { Observable } from 'rxjs'\r\n@Injectable()\r\nexport class RulesGuard implements CanActivate {\r\n  canActivate (\r\n    context:ExecutionContext\r\n  ):boolean|Promise<boolean>|Observable<boolean> {\r\n    const request = context.switchToHttp().getRequest()\r\n    console.log('\uD83D\uDE80 ~ AuthGuard ~ request:', request)\r\n    // validateRequest(request)\r\n    return true\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"\u4F7F\u7528\u4E00\u4E2A\u5B88\u536B"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { Controller, UseGuards } from '@nestjs/common'\r\n\r\n@Controller('code')\r\n@UseGuards(RulesGuard)\r\nexport class CodeController {}\r\n\r\n// \u4E5F\u53EF\u4EE5\u521B\u5EFA\u4E00\u4E2A\u5B9E\u4F8B\r\n@Controller('code')\r\n@UseGuards(new RulesGuard())\r\nexport class CodeController {}\n"})}),"\n",(0,s.jsxs)(r.p,{children:["\u5982\u679C\u8981\u4F7F\u7528\u5168\u5C40\u5B88\u536B\uFF0C\u4F7F\u7528 app \u4E0A\u9762\u7684 ",(0,s.jsx)(r.code,{children:"useGlobalGuards()"})," \u65B9\u6CD5"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"const app = await NestFactory.create(AppModule);\r\napp.useGlobalGuards(new RolesGuard());\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u62E6\u622A\u5668",children:"\u62E6\u622A\u5668"}),"\n",(0,s.jsx)(r.p,{children:"Interceptors"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\r\nimport { Observable } from 'rxjs';\r\nimport { tap } from 'rxjs/operators';\r\n\r\n@Injectable()\r\nexport class LoggingInterceptor implements NestInterceptor {\r\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\r\n    console.log('Before...');\r\n\r\n    const now = Date.now();\r\n    return next\r\n      .handle()\r\n      .pipe(\r\n        tap(() => console.log(`After... ${Date.now() - now}ms`)),\r\n      );\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\u81EA\u5B9A\u4E49\u8DEF\u7531\u88C5\u9970\u5668",children:"\u81EA\u5B9A\u4E49\u8DEF\u7531\u88C5\u9970\u5668"}),"\n",(0,s.jsx)(r.p,{children:"Custom route decorators"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-ts",children:"import { Reflector } from '@nestjs/core';\r\n\r\nexport const Roles = Reflector.createDecorator<string[]>();\r\n\n"})})]})}function p(e={}){let{wrapper:r}={...(0,t.a)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},3663:function(e,r,n){n.d(r,{Z:function(){return c},a:function(){return l}});var o=n(5271);let s={},t=o.createContext(s);function l(e){let r=o.useContext(t);return o.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),o.createElement(t.Provider,{value:r},e.children)}}}]);