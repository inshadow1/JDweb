> Create by **fall** on 14 Dec 2021
> Recently revised in 22 Aug 2024

## Controller

æ§åˆ¶å™¨

**æ§åˆ¶å™¨**å¤„ç†ä¼ å…¥çš„è¯·æ±‚å’Œæƒ³å®¢æˆ·ç«¯è¿”å›çš„å“åº”ï¼Œ

**è·¯ç”±**æœºåˆ¶æ§åˆ¶é‚£ä¸ªæ§åˆ¶å™¨å¤„ç†é‚£ä¸ªè¯·æ±‚ã€‚é€šå¸¸æ¯ä¸ªæ§åˆ¶å™¨æœ‰å¤šä¸ªè·¯ç”±ï¼Œä¸åŒçš„è·¯ç”±è¿›è¡Œä¸åŒçš„æ“ä½œã€‚

```js
/* cats.controller.ts */
import { Controller, Get } from '@nestjs/common';
@Controller('cats')
export class CatsController {
  @Get('/around') // ç”¨äºå‘Šè¯‰ Nest ä¸º HTTP è¯·æ±‚çš„ç‰¹å®šç«¯ç‚¹åˆ›å»ºå¤„ç†ç¨‹åº
  findAll(): string {
    return 'This action returns all cats';
  }
}
```

è·¯ç”±è·¯å¾„ ï¼Ÿä¸€ä¸ªå¤„ç†ç¨‹åºçš„è·¯ç”±è·¯å¾„æ˜¯é€šè¿‡è¿æ¥ä¸ºæ§åˆ¶å™¨ ï¼ˆControllerï¼‰ å£°æ˜çš„ï¼ˆå¯é€‰ï¼‰å‰ç¼€å’Œè¯·æ±‚è£…é¥°å™¨ä¸­æŒ‡å®šçš„ä»»ä½•è·¯å¾„æ¥ç¡®å®šçš„ã€‚

## Provider

Controller ä¼šè°ƒç”¨ provider ä¸­çš„å‡½æ•°ï¼Œ

provider åŒ…æ‹¬ service

```ts
// åˆ›å»º code.service.ts
import { Injectable } from '@nestjs/common'
@Injectable()
export class CodeService {
  findAll () {
    return [{
      name: 'ä»£ç ç‰‡æ®µ1',
      content: 'const a = 106',
    }]
  }
}

```

è°ƒç”¨ service

```ts
// code.controller.ts
import { CodeService } from './code.service'
@Controller('code')
export class CodeController {
  //
  constructor (private readonly codeService: CodeService) {}
  @Get()
  findAll () {
    return this.codeService.findAll()
  }
}
```



## Modules

```ts

import { Module, Global } from '@nestjs/common';
import { CatsController } from './cats.controller';
import { CatsService } from './cats.service';

@Global() // å°†æ­¤æ¨¡å—ä½¿ç”¨å…¨å±€è¿›è¡Œæš´éœ²
@Module({
  controllers: [CatsController],
  providers: [CatsService],
  exports: [CatsService],
})
export class CatsModule {}

```

å…¨å±€ module åº”è¯¥åªè¢«æ³¨å†Œä¸€æ¬¡

### dynamic modules

```ts
import { Module, DynamicModule } from '@nestjs/common';
import { createDatabaseProviders } from './database.providers';
import { Connection } from './connection.provider';

@Module({
  providers: [Connection],
  exports: [Connection],
})
export class DatabaseModule {
  static forRoot(entities = [], options?): DynamicModule {
    const providers = createDatabaseProviders(options, entities);
    return {
      module: DatabaseModule,
      providers: providers,
      exports: providers,
    };
  }
}
```

## Middleware

ä¸­é—´ä»¶ï¼Œå¯ä»¥åšå“ªäº›å†…å®¹ï¼Ÿ

- åœ¨ç‰¹å®šè¯·æ±‚ä¸­ï¼Œæ‰§è¡Œä»»æ„ä»£ç 
- å¯¹è¿”å›å†…å®¹è¿›è¡Œç»Ÿä¸€åŒ…è£…
- ç»ˆæ­¢ request-response å¾ªç¯
- è¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
- ä¸­é—´ä»¶å¦‚æœæ²¡æœ‰ç»“æŸ request-responseå¾ªç¯ï¼Œå¿…é¡»è°ƒç”¨ `next()`ï¼Œå¦åˆ™å°†ä¼šä¸€ç›´æŒ‚èµ·

```ts

import { Module, NestModule, RequestMethod, MiddlewareConsumer } from '@nestjs/common';
import { LoggerMiddleware } from './common/middleware/logger.middleware';
import { CatsModule } from './cats/cats.module';

@Module({
  imports: [CatsModule],
})
// é…ç½®ä¸­é—´ä»¶
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware)
    	// å¦‚æœè¦ä½¿ç”¨å¤šä¸ªä¸­é—´ä»¶å¯ä»¥
    	// .apply(cors(), helmet(), logger)
      .exclude( // æ’é™¤ä¸€äº›è·¯ç”±
        { path: 'cats', method: RequestMethod.GET },
        { path: 'cats', method: RequestMethod.POST },
        'cats/(.*)',
      )
      .forRoutes({ path: 'cats', method: RequestMethod.GET });
      // è¿˜å¯ä»¥ç»‘å®š Controller
    	// .forRoutes(CatsController)
  }
}
```

### å‡½æ•°å¼å†™æ³•

å¦‚æœä½ çš„ä¸­é—´ä»¶æ²¡æœ‰ä»»ä½•ä¾èµ–ï¼Œè¯·ä½¿ç”¨å‡½æ•°å¼ä¸­é—´ä»¶æ¥ä»£æ›¿

```ts
import { Request, Response, NextFunction } from 'express';

export function logger(req: Request, res: Response, next: NextFunction) {
  console.log(`Request...`);
  next();
};
```

## æ„å¤–æ•è·

https://docs.nestjs.com/exception-filters

é»˜è®¤å°±æœ‰ä¸€ä¸ªå…¨å±€æ„å¤–æ•è·

```json
{
  "message": "Cannot POST /faker",
  "error": "Not Found",
  "statusCode": 404
}
```

è‡ªå®šä¹‰å…¨å±€æ•è·

```js
@Get()
async findAll() {
  throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);
}
```

## ç®¡é“

pipe

https://docs.nestjs.com/pipes

- å°†æ•°æ®è½¬æ¢ä¸ºæƒ³è¦çš„ç±»å‹
- éªŒè¯ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦æœ‰æ•ˆ

å½“åœ¨ pipe ä¸­æŠ›å‡ºäº†ä¸€ä¸ªé”™è¯¯ï¼Œä¹‹åçš„ controller å°†ä¸ä¼šæ‰§è¡Œ

nest æä¾›çš„ pipe line

- `ValidationPipe`
- `ParseIntPipe`
- `ParseFloatPipe`
- `ParseBoolPipe`
- `ParseArrayPipe`
- `ParseUUIDPipe`ï¼ŒéªŒè¯ `ParseUUIDPipe()` ä½ åœ¨ä½¿ç”¨ UUID 3, 4 or 5 çš„ç‰ˆæœ¬
- `ParseEnumPipe`
- `DefaultValuePipe`
- `ParseFilePipe`

ä½¿ç”¨

```ts
@Controller('code')
export class CodeController {
  constructor (private readonly codeService: CodeService) {}

	@Get(':id')
  findOne (@Param('id', new ParseUUIDPipe()) id: string) {
    // request
    console.log('ğŸš€ ~ CodeController ~ findOne ~ request:', randomUUID())
    return this.codeService.findOne(id)
  }
}
```

```ts
@Controller('code')
export class CodeController {
  constructor (private readonly codeService: CodeService) {}@Post()
  
  @HttpCode(200)
  create (@Body('codeType', ParseTypePipe) createCodeDto: CreateCodeDto) {
    console.log('ğŸš€ ~ CodeController', createCodeDto)
    return this.codeService.create(createCodeDto)
  }
}
```

> ä¸ºä»€ä¹ˆä¸æ˜¯ä¸­é—´ä»¶ï¼Ÿ
>
> ä¸­é—´ä»¶ç¡®å®å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯ä¸­é—´ä»¶å¹¶ä¸çŸ¥é“ä½ è°ƒç”¨äº†å“ªä¸ªå‚æ•°ï¼Œä½¿ç”¨äº†å“ªä¸ªæ–¹æ³•å› æ­¤å¾ˆéš¾åˆ›é€ å‡ºé€šç”¨çš„ä¸­é—´ä»¶

å¢å¼º dto

```ts
@Controller('code')
export class CodeController {
  constructor (private readonly codeService: CodeService) {}

  @Patch(':id')
  @UseInterceptors(NoFilesInterceptor()) // æ¥æ”¶ FormData
  update (@Param('id') id: string, @Body(new ValidationPipe()) updateCodeDto: UpdateCodeDto) {
    console.log('ğŸš€ ~ CodeController ~ update ~ param:', updateCodeDto)
    return this.codeService.update(id, updateCodeDto)
  }
}
```



## å®ˆå«

guards

å®šä¹‰ä¸€ä¸ªå®ˆå«ï¼š

```ts
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common'
import { Observable } from 'rxjs'
@Injectable()
export class RulesGuard implements CanActivate {
  canActivate (
    context:ExecutionContext
  ):boolean|Promise<boolean>|Observable<boolean> {
    const request = context.switchToHttp().getRequest()
    console.log('ğŸš€ ~ AuthGuard ~ request:', request)
    // validateRequest(request)
    return true
  }
}
```

ä½¿ç”¨ä¸€ä¸ªå®ˆå«

```ts
import { Controller, UseGuards } from '@nestjs/common'

@Controller('code')
@UseGuards(RulesGuard)
export class CodeController {}

// ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå®ä¾‹
@Controller('code')
@UseGuards(new RulesGuard())
export class CodeController {}
```





å¦‚æœè¦ä½¿ç”¨å…¨å±€å®ˆå«ï¼Œä½¿ç”¨ app ä¸Šé¢çš„ `useGlobalGuards()` æ–¹æ³•

```ts
const app = await NestFactory.create(AppModule);
app.useGlobalGuards(new RolesGuard());
```



## æ‹¦æˆªå™¨

Interceptors

```ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('Before...');

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => console.log(`After... ${Date.now() - now}ms`)),
      );
  }
}
```





## è‡ªå®šä¹‰è·¯ç”±è£…é¥°å™¨

Custom route decorators

```ts
import { Reflector } from '@nestjs/core';

export const Roles = Reflector.createDecorator<string[]>();

```





